<style>
    .running-dashboard {
        margin: 2rem 0;
    }
    .run-hero {
        background: var(--entry);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 20px;
        display: grid;
        gap: 12px;
    }
    .run-hero-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
    }
    .run-hero-title {
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--primary);
    }
    .run-hero-subtitle {
        font-size: 0.85rem;
        color: var(--secondary);
    }
    .run-hero-name {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--primary);
    }
    .run-hero-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
    }
    .run-stat {
        background: var(--theme);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
        text-align: center;
    }
    .run-stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--secondary);
        letter-spacing: 0.08em;
    }
    .run-stat-value {
        font-size: 1.4rem;
        font-weight: 800;
        margin-top: 6px;
        color: var(--primary);
    }
    .run-error {
        color: #d6453d;
        font-size: 0.9rem;
    }
</style>

<div class="running-dashboard" data-strava-endpoint="{{ .Site.Params.stravaLatestEndpoint | default "" }}">
    <div class="run-hero" id="latest-run">
        <div class="run-hero-header">
            <div class="run-hero-title">Latest Run</div>
            <div class="run-hero-subtitle" id="latest-run-date">Loading…</div>
        </div>
        <div class="run-hero-name" id="latest-run-name">Fetching your most recent activity…</div>
        <div class="run-hero-grid">
            <div class="run-stat">
                <div class="run-stat-label">Distance</div>
                <div class="run-stat-value" id="latest-run-distance">—</div>
            </div>
            <div class="run-stat">
                <div class="run-stat-label">Time</div>
                <div class="run-stat-value" id="latest-run-time">—</div>
            </div>
            <div class="run-stat">
                <div class="run-stat-label">Pace</div>
                <div class="run-stat-value" id="latest-run-pace">—</div>
            </div>
            <div class="run-stat">
                <div class="run-stat-label">Elevation</div>
                <div class="run-stat-value" id="latest-run-elevation">—</div>
            </div>
        </div>
        <div class="run-hero-subtitle" id="latest-run-meta"></div>
        <div class="run-error" id="latest-run-error" style="display:none"></div>
    </div>
</div>

<script>
(() => {
    const root = document.querySelector('.running-dashboard');
    if (!root) return;
    const endpoint = root.getAttribute('data-strava-endpoint');

    const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };

    const showError = (message) => {
        const el = document.getElementById('latest-run-error');
        if (!el) return;
        el.style.display = 'block';
        el.textContent = message;
    };

    const metersToMiles = (m) => m / 1609.344;
    const secondsToHms = (s) => {
        const hrs = Math.floor(s / 3600);
        const mins = Math.floor((s % 3600) / 60);
        const secs = Math.floor(s % 60);
        const pad = (n) => String(n).padStart(2, '0');
        if (hrs > 0) return `${hrs}:${pad(mins)}:${pad(secs)}`;
        return `${mins}:${pad(secs)}`;
    };
    const paceFrom = (seconds, miles) => {
        if (!miles || miles <= 0 || !seconds) return '—';
        const paceSec = seconds / miles;
        const mins = Math.floor(paceSec / 60);
        const secs = Math.round(paceSec % 60);
        return `${mins}:${String(secs).padStart(2, '0')} /mi`;
    };

    if (!endpoint) {
        setText('latest-run-name', 'Strava endpoint not configured yet.');
        setText('latest-run-date', '');
        showError('Set params.stravaLatestEndpoint in hugo.toml to your serverless endpoint.');
        return;
    }

    fetch(endpoint, { cache: 'no-store' })
        .then((res) => {
            if (!res.ok) throw new Error(`Request failed: ${res.status}`);
            return res.json();
        })
        .then((activity) => {
            const name = activity.name || 'Latest Run';
            const dateStr = activity.start_date_local || activity.start_date || '';
            const distanceM = activity.distance_m ?? activity.distance ?? 0;
            const movingTimeS = activity.moving_time_s ?? activity.moving_time ?? 0;
            const elevationM = activity.total_elevation_gain_m ?? activity.total_elevation_gain ?? 0;

            const miles = metersToMiles(distanceM);
            const distance = miles > 0 ? `${miles.toFixed(2)} mi` : '—';
            const time = movingTimeS ? secondsToHms(movingTimeS) : '—';
            const pace = paceFrom(movingTimeS, miles);
            const elevation = `${Math.round(elevationM)} m`;

            setText('latest-run-name', name);
            setText('latest-run-date', dateStr ? new Date(dateStr).toLocaleDateString() : '');
            setText('latest-run-distance', distance);
            setText('latest-run-time', time);
            setText('latest-run-pace', pace);
            setText('latest-run-elevation', elevation);
            setText('latest-run-meta', dateStr ? new Date(dateStr).toLocaleTimeString() : '');
        })
        .catch((err) => {
            setText('latest-run-name', 'Unable to load latest activity.');
            setText('latest-run-date', '');
            showError(err.message || 'Unknown error');
        });
})();
</script>
